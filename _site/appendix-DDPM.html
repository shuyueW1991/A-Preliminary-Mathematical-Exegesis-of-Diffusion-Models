<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="stylesheet" href="/A-Preliminary-Mathematical-Exegesis-of-Diffusion-Models/assets/css/just-the-docs-default.css"> <link rel="stylesheet" href="/A-Preliminary-Mathematical-Exegesis-of-Diffusion-Models/assets/css/just-the-docs-head-nav.css" id="jtd-head-nav-stylesheet"> <style id="jtd-nav-activation"> .site-nav > ul.nav-list:first-child > li:not(:nth-child(7)) > a, .site-nav > ul.nav-list:first-child > li > ul > li a { background-image: none; } .site-nav > ul.nav-list:not(:first-child) a, .site-nav li.external a { background-image: none; } .site-nav > ul.nav-list:first-child > li:nth-child(7) > a { font-weight: 600; text-decoration: none; }.site-nav > ul.nav-list:first-child > li:nth-child(7) > button svg { transform: rotate(-90deg); }.site-nav > ul.nav-list:first-child > li.nav-list-item:nth-child(7) > ul.nav-list { display: block; } </style> <script src="/A-Preliminary-Mathematical-Exegesis-of-Diffusion-Models/assets/js/vendor/lunr.min.js"></script> <script src="/A-Preliminary-Mathematical-Exegesis-of-Diffusion-Models/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>Appendix - Code for DDPM | PrgM2 /pR’gem/2</title> <meta name="generator" content="Jekyll v3.10.0" /> <meta property="og:title" content="Appendix - Code for DDPM" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="A preliminary mathematical exegesis of diffusion models" /> <meta property="og:description" content="A preliminary mathematical exegesis of diffusion models" /> <link rel="canonical" href="http://localhost:4000/A-Preliminary-Mathematical-Exegesis-of-Diffusion-Models/appendix-DDPM.html" /> <meta property="og:url" content="http://localhost:4000/A-Preliminary-Mathematical-Exegesis-of-Diffusion-Models/appendix-DDPM.html" /> <meta property="og:site_name" content="PrgM2 /pR’gem/2" /> <meta property="og:type" content="website" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Appendix - Code for DDPM" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"A preliminary mathematical exegesis of diffusion models","headline":"Appendix - Code for DDPM","url":"http://localhost:4000/A-Preliminary-Mathematical-Exegesis-of-Diffusion-Models/appendix-DDPM.html"}</script> <!-- End Jekyll SEO tag --> </head> <body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE --> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"> <title id="svg-external-link-title">(external link)</title> <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <!-- Bootstrap Icons. MIT License: https://github.com/twbs/icons/blob/main/LICENSE.md --> <symbol id="svg-copy" viewBox="0 0 16 16"> <title>Copy</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/> <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"> <title>Copied</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"> <path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header" role="banner"> <a href="/A-Preliminary-Mathematical-Exegesis-of-Diffusion-Models/" class="site-title lh-tight"> PrgM2 /pR'gem/2 </a> <button id="menu-button" class="site-button btn-reset" aria-label="Toggle menu" aria-pressed="false"> <svg viewBox="0 0 24 24" class="icon" aria-hidden="true"><use xlink:href="#svg-menu"></use></svg> </button> </div> <nav aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/A-Preliminary-Mathematical-Exegesis-of-Diffusion-Models/" class="nav-list-link">Cover Page</a></li><li class="nav-list-item"><a href="/A-Preliminary-Mathematical-Exegesis-of-Diffusion-Models/00-chpt0.html" class="nav-list-link">Chapter 0 - Preface</a></li><li class="nav-list-item"><a href="/A-Preliminary-Mathematical-Exegesis-of-Diffusion-Models/01-chpt1.html" class="nav-list-link">Chapter 1 - The High-Dimensional Structure of True Data</a></li><li class="nav-list-item"><a href="/A-Preliminary-Mathematical-Exegesis-of-Diffusion-Models/02-chpt2.html" class="nav-list-link">Chapter 2 - The ELBO Paradigm --- Proxy Objective for True Data Maximization</a></li><li class="nav-list-item"><a href="/A-Preliminary-Mathematical-Exegesis-of-Diffusion-Models/03-chpt3.html" class="nav-list-link">Chapter 3 - Dissecting the ELBO - Diffusion Models as Distribution-Transitioned Dynamics</a></li><li class="nav-list-item"><a href="/A-Preliminary-Mathematical-Exegesis-of-Diffusion-Models/04-chpt4.html" class="nav-list-link">Chapter 4 - Implementation on machine - Get our hands dirty</a></li><li class="nav-list-item"><a href="/A-Preliminary-Mathematical-Exegesis-of-Diffusion-Models/appendix-DDPM.html" class="nav-list-link">Appendix - Code for DDPM</a></li><li class="nav-list-item"><a href="/A-Preliminary-Mathematical-Exegesis-of-Diffusion-Models/resume.html" class="nav-list-link">About Author / Cite this</a></li><li class="nav-list-item"><a href="/A-Preliminary-Mathematical-Exegesis-of-Diffusion-Models/sponsor.html" class="nav-list-link">Buy me coffee(s)</a></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search" role="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search PrgM2 /pR'gem/2" aria-label="Search PrgM2 /pR'gem/2" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> </div> <div class="main-content-wrap"> <div id="main-content" class="main-content"> <main> <head> <title>A Preliminary Mathematical Exegesis of Diffusion Models</title> <meta name="description" content="An in-depth mathematical analysis of diffusion models in machine learning." /> <meta name="keywords" content="diffusion models, mathematics, machine learning, exegesis" /> <meta name="author" content="Shuyue Wang" /> <!-- Open Graph (for social sharing) --> <meta property="og:title" content="A Preliminary Mathematical Exegesis of Diffusion Models" /> <meta property="og:description" content="An in-depth mathematical analysis of diffusion models in machine learning." /> <meta property="og:url" content="https://shuyuew1991.github.io/A-Preliminary-Mathematical-Exegesis-of-Diffusion-Models/" /> <meta property="og:type" content="website" /> </head> <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" async=""></script> <div style="text-align: left; font-size: 1.3em;"> Appendix - Code for DDPM. </div> <p><br /></p> <p>DDPM is a fundamental diffuison model, which is often used as the demo for the algorithm, because it is the simplest of all its descendant variants. To train a diffusion model such as DDPM, you can vaguely think of some blocks to define. It is not necessary to memorize anything: thinking as the script will do. We should easily envision that some common packages that should be imported, the details of which can be determined while coding the subsequent. We should make something to load the dataset, with some cleaning. A class can help us do this. Then we come up with idea that the equivalent loss is the noise itself. We can use UNet to predict that nosie. With this, training paradigm and schedulers can be prepared. And that’s all. Let’s see a code coded by me.</p> <p>The code is not written linearly piece by piece, a non-linear adaptation and change is unavoidable. The following is just one final look of the code.</p><hr /> <p>Let’s decide the gpu that we use in a server. Suppose we have 8.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">os</span>
<span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="s">"CUDA_VISIBLE_DEVICES"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"0,1,2,3,4,5,6,7"</span>
</code></pre></div></div> <p>Some hyper params should be assigned in configuration.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Config</span><span class="p">:</span>
    <span class="n">data_dir</span>      <span class="o">=</span> <span class="s">"/image_folder"</span>
    <span class="n">save_path</span>     <span class="o">=</span> <span class="s">"ddpm_best.pt"</span>
    <span class="n">epochs</span>        <span class="o">=</span> <span class="mi">1000</span>
    <span class="n">batch_size</span>    <span class="o">=</span> <span class="mi">4096</span> 
    <span class="n">lr</span>            <span class="o">=</span> <span class="mf">2e-4</span>
    <span class="n">timesteps</span>     <span class="o">=</span> <span class="mi">1000</span>
    <span class="n">image_size</span>    <span class="o">=</span> <span class="mi">64</span>
<span class="n">cfg</span> <span class="o">=</span> <span class="n">Config</span><span class="p">()</span>
</code></pre></div></div> <p>Some codes requires the images are located in an intermediate class_tagged folder, we decided to eliminate this requirement. The batch_size can be set to maximize the use of gpu. You can install <code class="language-plaintext highlighter-rouge">nvitop</code> to check instantly the status of the gpus. The image_size is the real size that is transformed into for the images. timesteps being 1000 is a common practice. The final line is the instantiation of the class.</p> <p>Let’s define how to load the images first.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">FlatFolder</span><span class="p">(</span><span class="n">VisionDataset</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">().</span><span class="n">__init__</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">)</span>
        
        <span class="c1"># Supported image extensions
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">extensions</span> <span class="o">=</span> <span class="p">(</span><span class="s">'.jpg'</span><span class="p">,</span> <span class="s">'.jpeg'</span><span class="p">,</span> <span class="s">'.png'</span><span class="p">,</span> <span class="s">'.bmp'</span><span class="p">,</span> <span class="s">'.tiff'</span><span class="p">,</span> <span class="s">'.tif'</span><span class="p">,</span> <span class="s">'.webp'</span><span class="p">)</span>
        
        <span class="c1"># Get all image files
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">samples</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">Path</span><span class="p">(</span><span class="n">root</span><span class="p">).</span><span class="n">iterdir</span><span class="p">()</span> 
            <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="n">is_file</span><span class="p">()</span> <span class="ow">and</span> <span class="n">p</span><span class="p">.</span><span class="n">suffix</span><span class="p">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">extensions</span>
        <span class="p">]</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">samples</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s">"No images found in </span><span class="si">{</span><span class="n">root</span><span class="si">}</span><span class="s"> with extensions </span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">extensions</span><span class="si">}</span><span class="s">!"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">samples</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="p">.</span><span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">).</span><span class="n">convert</span><span class="p">(</span><span class="s">'RGB'</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">transform</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">transform</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
            
        <span class="c1"># Return a dummy label (0) for compatibility
</span>        <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">samples</span><span class="p">)</span>
</code></pre></div></div> <p>and we equipe it with</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">torchvision.datasets</span> <span class="kn">import</span> <span class="n">VisionDataset</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
</code></pre></div></div> <p><code class="language-plaintext highlighter-rouge">__init__</code> and <code class="language-plaintext highlighter-rouge">__getitem__</code> are natual components of dataloader.</p> <p>We now define a class to add noise:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">GaussianDiffusion</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timesteps</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">beta_start</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">beta_end</span><span class="o">=</span><span class="mf">0.02</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">().</span><span class="n">__init__</span><span class="p">()</span>
        <span class="n">betas</span>  <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">beta_start</span><span class="p">,</span> <span class="n">beta_end</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">)</span>
        <span class="n">alphas</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">-</span> <span class="n">betas</span>
        <span class="n">alpha_hats</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">cumprod</span><span class="p">(</span><span class="n">alphas</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># register as buffers → move with .to(device) automatically
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s">"betas"</span><span class="p">,</span> <span class="n">betas</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s">"alphas"</span><span class="p">,</span> <span class="n">alphas</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s">"alpha_hats"</span><span class="p">,</span> <span class="n">alpha_hats</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">timesteps</span> <span class="o">=</span> <span class="n">timesteps</span>

    <span class="k">def</span> <span class="nf">q_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">noise</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">noise</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">noise</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">randn_like</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
        <span class="n">sqrt_alpha_hat</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">alpha_hats</span><span class="p">[</span><span class="n">t</span><span class="p">].</span><span class="n">sqrt</span><span class="p">()</span>      <span class="p">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">sqrt_one_minus</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="p">.</span><span class="n">alpha_hats</span><span class="p">[</span><span class="n">t</span><span class="p">]).</span><span class="n">sqrt</span><span class="p">().</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sqrt_alpha_hat</span> <span class="o">*</span> <span class="n">x0</span> <span class="o">+</span> <span class="n">sqrt_one_minus</span> <span class="o">*</span> <span class="n">noise</span>

</code></pre></div></div> <p>and of course we have to equip it with:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="n">nn</span>

</code></pre></div></div> <p>Inherit <code class="language-plaintext highlighter-rouge">nn.Module</code> is a common practice. So is <code class="language-plaintext highlighter-rouge">__init__</code> for the class. The class is basically for determining the noise at all <code class="language-plaintext highlighter-rouge">t</code> for given <code class="language-plaintext highlighter-rouge">x0</code>. They’re the target for the noise prediction, for sure. The <code class="language-plaintext highlighter-rouge">q_sample</code> is basically <code class="language-plaintext highlighter-rouge">q(x_t | x_0)</code>that defines the noising process:</p> \[q(x_t | x_0) = \mathcal{N}(x_t; \sqrt{\bar{\alpha}_t} x_0, (1 - \bar{\alpha}_t) \mathbf{I})\] <p>where:</p> <ul> <li>\(\alpha_t = 1 - \beta_t \), with \( \beta_t \) being the noise schedule at step \( t \),</li> <li>\( \bar{\alpha}<em>t = \prod</em>{s=1}^t \alpha_s \),</li> <li>\( \mathcal{N} \) denotes a Gaussian distribution with mean \( \sqrt{\bar{\alpha}_t} x_0 \) and variance \( (1 - \bar{\alpha}_t) \mathbf{I} \).</li> </ul> <p>This can also be written in terms of the reparameterization trick as:</p> \[x_t = \sqrt{\bar{\alpha}_t} x_0 + \sqrt{1 - \bar{\alpha}_t} \epsilon, \quad \epsilon \sim \mathcal{N}(0, \mathbf{I})\] <p>By reshaping with <code class="language-plaintext highlighter-rouge">.view(-1,1,1,1)</code>, the coefficients are broadcast correctly during multiplication across all dimensions of the image tensors. The -1 preserves the <code class="language-plaintext highlighter-rouge">batch</code> dimension, while the three 1s create singleton dimensions for <code class="language-plaintext highlighter-rouge">channels</code>, <code class="language-plaintext highlighter-rouge">height</code>, and <code class="language-plaintext highlighter-rouge">width</code>, allowing the coefficients to be applied uniformly across the spatial dimensions of each image in the batch.</p> <p>So we can fulfill the preparation of the training in the main function:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">device</span><span class="p">(</span><span class="s">"cuda"</span> <span class="k">if</span> <span class="n">torch</span><span class="p">.</span><span class="n">cuda</span><span class="p">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s">"cpu"</span><span class="p">)</span>

    <span class="c1"># dataset
</span>    <span class="n">tfm</span> <span class="o">=</span> <span class="n">transforms</span><span class="p">.</span><span class="n">Compose</span><span class="p">([</span>
        <span class="n">transforms</span><span class="p">.</span><span class="n">Resize</span><span class="p">((</span><span class="n">cfg</span><span class="p">.</span><span class="n">image_size</span><span class="p">,</span> <span class="n">cfg</span><span class="p">.</span><span class="n">image_size</span><span class="p">)),</span>
        <span class="n">transforms</span><span class="p">.</span><span class="n">ToTensor</span><span class="p">()</span>
    <span class="p">])</span>
    
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">FlatFolder</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">tfm</span><span class="p">)</span>

    <span class="n">train_len</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.9</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">))</span>
    <span class="n">val_len</span>   <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span> <span class="o">-</span> <span class="n">train_len</span>
    <span class="n">train_set</span><span class="p">,</span> <span class="n">val_set</span> <span class="o">=</span> <span class="n">random_split</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="p">[</span><span class="n">train_len</span><span class="p">,</span> <span class="n">val_len</span><span class="p">])</span>
    <span class="n">dl_train</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">train_set</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">dl_val</span>   <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">val_set</span><span class="p">,</span>   <span class="n">batch_size</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

</code></pre></div></div> <p>Ok, now we come to design the module to predict the noise, which is UNet.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">UNet</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_channels</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">out_channels</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="mi">64</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">().</span><span class="n">__init__</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">block</span><span class="p">(</span><span class="n">in_c</span><span class="p">,</span> <span class="n">out_c</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">nn</span><span class="p">.</span><span class="n">Sequential</span><span class="p">(</span>
                <span class="n">nn</span><span class="p">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_c</span><span class="p">,</span> <span class="n">out_c</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                <span class="n">nn</span><span class="p">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
                <span class="n">nn</span><span class="p">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">out_c</span><span class="p">,</span> <span class="n">out_c</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                <span class="n">nn</span><span class="p">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">enc1</span> <span class="o">=</span> <span class="n">block</span><span class="p">(</span><span class="n">in_channels</span><span class="p">,</span> <span class="n">base</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">enc2</span> <span class="o">=</span> <span class="n">block</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">base</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">enc3</span> <span class="o">=</span> <span class="n">block</span><span class="p">(</span><span class="n">base</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">base</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">pool</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">up</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">Upsample</span><span class="p">(</span><span class="n">scale_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">"nearest"</span><span class="p">)</span>

        <span class="c1"># These project upsampled tensors to match skip connection dims
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">reduce_e3</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">base</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">base</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">reduce_d2</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">base</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">dec2</span> <span class="o">=</span> <span class="n">block</span><span class="p">(</span><span class="n">base</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">base</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">dec1</span> <span class="o">=</span> <span class="n">block</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">base</span><span class="p">)</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">outc</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t_embed</span><span class="p">):</span>
        <span class="n">t_embed</span> <span class="o">=</span> <span class="n">t_embed</span><span class="p">[:,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">].</span><span class="n">expand</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">x</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">cat</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">t_embed</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">e1</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">enc1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">e2</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">enc2</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">pool</span><span class="p">(</span><span class="n">e1</span><span class="p">))</span>
        <span class="n">e3</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">enc3</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">pool</span><span class="p">(</span><span class="n">e2</span><span class="p">))</span>

        <span class="c1"># Project upsampled layers before addition
</span>        <span class="n">u3</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">up</span><span class="p">(</span><span class="n">e3</span><span class="p">)</span>
        <span class="n">u3</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">reduce_e3</span><span class="p">(</span><span class="n">u3</span><span class="p">)</span>
        <span class="n">d2</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">dec2</span><span class="p">(</span><span class="n">u3</span> <span class="o">+</span> <span class="n">e2</span><span class="p">)</span>

        <span class="n">u2</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">up</span><span class="p">(</span><span class="n">d2</span><span class="p">)</span>
        <span class="n">u2</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">reduce_d2</span><span class="p">(</span><span class="n">u2</span><span class="p">)</span>
        <span class="n">d1</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">dec1</span><span class="p">(</span><span class="n">u2</span> <span class="o">+</span> <span class="n">e1</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">outc</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span>

</code></pre></div></div> <p>The <code class="language-plaintext highlighter-rouge">nn.MaxPool2d(2)</code> function creates a layer that downsamples the input by taking the maximum value across each 2x2 window.</p> <p>The <code class="language-plaintext highlighter-rouge">nn.Upsample</code> function creates a module that upsamples the input data by a factor of 2 in both the height and width dimensions, using nearest-neighbor interpolation.</p> <p>Here’s a merged and LaTeX-formatted version of parts 2 through 5, describing how UNet is used to predict noise in diffusion models:</p> <p>The core idea is to train a UNet to predict the noise \(\epsilon\) added to a noisy image \(x_t\) at timestep \(t\), enabling iterative denoising. The goal of denoising in the reverse process is to recover the clean image \(x_0\) from pure noise \(x_T\) by reversing the diffusion process. At each timestep \(t\), the UNet predicts the noise \(\epsilon_\theta(x_t, t)\) in the noisy image \(x_t\). The denoising step should be analytically given by:</p> \[x_{t-1} = \frac{1}{\sqrt{\alpha_t}} \left( x_t - \frac{1 - \alpha_t}{\sqrt{1 - \bar{\alpha}_t}} \epsilon_\theta(x_t, t) \right) + \sigma_t z\] <p>where:</p> <ul> <li>\(\epsilon_\theta(x_t, t)\) is the UNet’s predicted noise,</li> <li>\(\alpha_t\) and \(\bar{\alpha}_t\) are noise scheduling terms,</li> </ul> <p>but the UNet is directly trained to minimize the mean squared error (MSE) between the predicted and true noise:</p> \[\mathcal{L} = \mathbb{E}_{t,x_0,\epsilon} \left[ \| \epsilon - \epsilon_\theta(x_t, t) \|^2 \right]\] <p>The UNet is chosen for noise prediction due to its ability to capture multi-scale features. Key components include:</p> <ul> <li><strong>Encoder-Decoder Structure</strong>: <ul> <li>The encoder downsamples the noisy input \(x_t)\ to extract high-level features.</li> <li>The decoder upsamples while refining features to reconstruct the noise map.</li> </ul> </li> <li> <p><strong>Skip Connections</strong>:<br /> Preserve spatial details lost during downsampling, crucial for accurate noise estimation.</p> </li> <li><strong>Timestep Conditioning</strong>:<br /> The current timestep \(t\) is embedded (e.g., as a sinusoidal or learned embedding) and injected into the UNet to guide denoising.</li> </ul> <p>To generate an image from noise:</p> <ol> <li>Start with pure Gaussian noise \(x_T \sim \mathcal{N}(0, I)\).</li> <li>For each timestep \(t = T, \dots, 1\): <ul> <li>Predict noise: \(\epsilon_\theta(x_t, t)\).</li> <li>Apply the reverse update rule (above) to compute \(x_{t-1}\).</li> </ul> </li> <li>Final output \(x_0\) is the generated image.</li> </ol> <p>Why UNet Excels at Noise Prediction？</p> <ul> <li><strong>Multi-Scale Processing</strong>: Noise exists at varying frequencies; UNet’s hierarchical structure captures both coarse and fine noise patterns.</li> <li><strong>Efficiency</strong>: Skip connections mitigate information loss, unlike plain CNNs.</li> <li><strong>Flexibility</strong>: Can be conditioned on timesteps, text, or other inputs (e.g., in latent diffusion models).</li> </ul> <p>Now, we can write the rest of the main function to realize the training stuff:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">main</span>
    <span class="c1">####### data prep is already up there.
</span>
    <span class="c1">####### model &amp; diffusion
</span>    <span class="c1"># net = UNet().to(device) # single-GPU
</span>    <span class="n">net</span> <span class="o">=</span> <span class="n">UNet</span><span class="p">()</span>  <span class="c1"># create bare model
</span>    <span class="n">net</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">DataParallel</span><span class="p">(</span><span class="n">net</span><span class="p">)</span>  <span class="c1"># for multi-GPU
</span>    <span class="n">net</span> <span class="o">=</span> <span class="n">net</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>  <span class="c1"># move model to GPU
</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">GaussianDiffusion</span><span class="p">(</span><span class="n">timesteps</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">timesteps</span><span class="p">).</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>  <span class="c1"># create diffusion model
</span>    <span class="n">opt</span>  <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">optim</span><span class="p">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">net</span><span class="p">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">lr</span><span class="p">)</span>  <span class="c1"># create optimizer
</span>    <span class="n">mse</span>  <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">MSELoss</span><span class="p">()</span>  <span class="c1"># define loss function
</span>
    <span class="n">best</span> <span class="o">=</span> <span class="n">math</span><span class="p">.</span><span class="n">inf</span>  <span class="c1"># keep track of best validation loss
</span>    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="n">epochs</span><span class="p">):</span>  <span class="c1"># loop over epochs
</span>        <span class="n">net</span><span class="p">.</span><span class="n">train</span><span class="p">()</span>  <span class="c1"># switch to training mode
</span>        <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">dl_train</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s">"Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">epochs</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>  <span class="c1"># create tqdm progress bar
</span>        <span class="k">for</span> <span class="n">imgs</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">pbar</span><span class="p">:</span>  <span class="c1"># loop over mini-batches
</span>            <span class="n">imgs</span> <span class="o">=</span> <span class="n">imgs</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>  <span class="c1"># move data to GPU
</span>            <span class="n">t</span>    <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">cfg</span><span class="p">.</span><span class="n">timesteps</span><span class="p">,</span> <span class="p">(</span><span class="n">imgs</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>  <span class="c1"># sample random timesteps
</span>            <span class="n">noise</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">randn_like</span><span class="p">(</span><span class="n">imgs</span><span class="p">)</span>  <span class="c1"># generate random noise
</span>            <span class="n">x_t</span>   <span class="o">=</span> <span class="n">diff</span><span class="p">.</span><span class="n">q_sample</span><span class="p">(</span><span class="n">imgs</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">noise</span><span class="p">)</span>  <span class="c1"># sample x_t according to q(x_t | x_0)
</span>            <span class="n">pred</span>  <span class="o">=</span> <span class="n">net</span><span class="p">(</span><span class="n">x_t</span><span class="p">,</span> <span class="n">t</span><span class="p">.</span><span class="nb">float</span><span class="p">()</span><span class="o">/</span><span class="n">cfg</span><span class="p">.</span><span class="n">timesteps</span><span class="p">)</span>  <span class="c1"># predict noise
</span>            <span class="n">loss</span>  <span class="o">=</span> <span class="n">mse</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">noise</span><span class="p">)</span>  <span class="c1"># compute loss
</span>            <span class="n">opt</span><span class="p">.</span><span class="n">zero_grad</span><span class="p">();</span> <span class="n">loss</span><span class="p">.</span><span class="n">backward</span><span class="p">();</span> <span class="n">opt</span><span class="p">.</span><span class="n">step</span><span class="p">()</span>  <span class="c1"># backprop and update params
</span>            <span class="n">pbar</span><span class="p">.</span><span class="n">set_postfix</span><span class="p">(</span><span class="n">train_loss</span><span class="o">=</span><span class="n">loss</span><span class="p">.</span><span class="n">item</span><span class="p">())</span>  <span class="c1"># update progress bar with training loss
</span>
        <span class="c1"># ------ validation ------
</span>        <span class="n">net</span><span class="p">.</span><span class="nb">eval</span><span class="p">()</span>  <span class="c1"># switch to eval mode
</span>        <span class="n">val_loss</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># keep track of validation loss
</span>        <span class="k">with</span> <span class="n">torch</span><span class="p">.</span><span class="n">no_grad</span><span class="p">():</span>  <span class="c1"># disable gradients
</span>            <span class="k">for</span> <span class="n">imgs</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">dl_val</span><span class="p">:</span>  <span class="c1"># loop over validation set
</span>                <span class="n">imgs</span> <span class="o">=</span> <span class="n">imgs</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>  <span class="c1"># move data to GPU
</span>                <span class="n">t</span>    <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">cfg</span><span class="p">.</span><span class="n">timesteps</span><span class="p">,</span> <span class="p">(</span><span class="n">imgs</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>  <span class="c1"># sample random timesteps
</span>                <span class="n">noise</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">randn_like</span><span class="p">(</span><span class="n">imgs</span><span class="p">)</span>  <span class="c1"># generate random noise
</span>                <span class="n">x_t</span>   <span class="o">=</span> <span class="n">diff</span><span class="p">.</span><span class="n">q_sample</span><span class="p">(</span><span class="n">imgs</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">noise</span><span class="p">)</span>  <span class="c1"># sample x_t according to q(x_t | x_0)
</span>                <span class="n">pred</span>  <span class="o">=</span> <span class="n">net</span><span class="p">(</span><span class="n">x_t</span><span class="p">,</span> <span class="n">t</span><span class="p">.</span><span class="nb">float</span><span class="p">()</span><span class="o">/</span><span class="n">cfg</span><span class="p">.</span><span class="n">timesteps</span><span class="p">)</span>  <span class="c1"># predict noise
</span>                <span class="n">val_loss</span> <span class="o">+=</span> <span class="n">mse</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">noise</span><span class="p">).</span><span class="n">item</span><span class="p">()</span>  <span class="c1"># compute loss
</span>        <span class="n">val_loss</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dl_val</span><span class="p">)</span>  <span class="c1"># average over validation set
</span>        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"➜  Val loss: </span><span class="si">{</span><span class="n">val_loss</span><span class="si">:</span><span class="p">.</span><span class="mi">5</span><span class="n">f</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>  <span class="c1"># print validation loss
</span>
        <span class="c1"># checkpoint
</span>        <span class="k">if</span> <span class="n">val_loss</span> <span class="o">&lt;</span> <span class="n">best</span><span class="p">:</span>  <span class="c1"># if validation loss improved
</span>            <span class="n">torch</span><span class="p">.</span><span class="n">save</span><span class="p">(</span><span class="n">net</span><span class="p">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">cfg</span><span class="p">.</span><span class="n">save_path</span><span class="p">)</span>  <span class="c1"># save model
</span>            <span class="n">best</span> <span class="o">=</span> <span class="n">val_loss</span>  <span class="c1"># update best validation loss
</span>            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"✅  New best model saved (</span><span class="si">{</span><span class="n">best</span><span class="si">:</span><span class="p">.</span><span class="mi">5</span><span class="n">f</span><span class="si">}</span><span class="s">)"</span><span class="p">)</span>  <span class="c1"># print message
</span>
</code></pre></div></div> <p>alright！ with checking again the imported packages</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">math</span><span class="p">,</span> <span class="n">torch</span><span class="p">,</span> <span class="n">torch</span><span class="p">.</span><span class="n">nn</span> <span class="k">as</span> <span class="n">nn</span><span class="p">,</span> <span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="n">functional</span> <span class="k">as</span> <span class="n">F</span>
<span class="kn">from</span> <span class="nn">torchvision</span> <span class="kn">import</span> <span class="n">transforms</span><span class="p">,</span> <span class="n">datasets</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span><span class="p">,</span> <span class="n">random_split</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
</code></pre></div></div> <p>we’re finished with the code of training script of DDPM.</p> <p>And now i provide you with the inference script:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">os</span>
<span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="s">"CUDA_VISIBLE_DEVICES"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"7"</span>

<span class="s">"""
ddpm_infer.py  –  sample images with the trained DDPM
No argparse / argv; edit InferCfg below.
"""</span>

<span class="kn">import</span> <span class="nn">math</span><span class="p">,</span> <span class="n">torch</span><span class="p">,</span> <span class="n">torch</span><span class="p">.</span><span class="n">nn</span> <span class="k">as</span> <span class="n">nn</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">torchvision.utils</span> <span class="kn">import</span> <span class="n">save_image</span>

<span class="c1"># ──────────────────────────────────────────
# 1.  Shared classes, config from training
# ──────────────────────────────────────────
</span><span class="kn">from</span> <span class="nn">ddpm_train</span> <span class="kn">import</span> <span class="n">UNet</span><span class="p">,</span> <span class="n">GaussianDiffusion</span><span class="p">,</span> <span class="n">cfg</span>   <span class="c1"># keep name of training file
</span>
<span class="c1"># ──────────────────────────────────────────
# 2.  Inference configuration (EDIT HERE)
# ──────────────────────────────────────────
</span><span class="k">class</span> <span class="nc">InferCfg</span><span class="p">:</span>
    <span class="n">n_samples</span> <span class="o">=</span> <span class="mi">64</span>               <span class="c1"># total images to generate
</span>    <span class="n">out_dir</span>   <span class="o">=</span> <span class="s">"samples"</span>        <span class="c1"># folder for the grid PNG
</span>    <span class="n">ckpt_path</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="n">save_path</span>    <span class="c1"># uses same path as training
</span><span class="n">infer</span> <span class="o">=</span> <span class="n">InferCfg</span><span class="p">()</span>

<span class="c1"># ──────────────────────────────────────────
# 3.  Device &amp; model loading
# ──────────────────────────────────────────
</span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">device</span><span class="p">(</span><span class="s">"cuda"</span> <span class="k">if</span> <span class="n">torch</span><span class="p">.</span><span class="n">cuda</span><span class="p">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s">"cpu"</span><span class="p">)</span>

<span class="n">net</span>   <span class="o">=</span> <span class="n">UNet</span><span class="p">()</span>                                <span class="c1"># create bare model
</span><span class="n">state</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">infer</span><span class="p">.</span><span class="n">ckpt_path</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="c1"># Strip "module." if checkpoint came from DataParallel training
</span><span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">k</span><span class="p">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">"module."</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">state</span><span class="p">.</span><span class="n">keys</span><span class="p">()):</span>
    <span class="n">state</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s">"module."</span><span class="p">,</span> <span class="s">""</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">state</span><span class="p">.</span><span class="n">items</span><span class="p">()}</span>

<span class="n">net</span><span class="p">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
<span class="k">if</span> <span class="n">torch</span><span class="p">.</span><span class="n">cuda</span><span class="p">.</span><span class="n">device_count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">net</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">DataParallel</span><span class="p">(</span><span class="n">net</span><span class="p">)</span>                <span class="c1"># multi‑GPU wrapper
</span><span class="n">net</span> <span class="o">=</span> <span class="n">net</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">).</span><span class="nb">eval</span><span class="p">()</span>

<span class="n">diff</span> <span class="o">=</span> <span class="n">GaussianDiffusion</span><span class="p">(</span><span class="n">timesteps</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">timesteps</span><span class="p">).</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

<span class="c1"># ──────────────────────────────────────────
# 4.  Sampling loop
# ──────────────────────────────────────────
</span><span class="o">@</span><span class="n">torch</span><span class="p">.</span><span class="n">no_grad</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="n">batch</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="s">"""Returns a batch of images in [-1,1]."""</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">randn</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">cfg</span><span class="p">.</span><span class="n">image_size</span><span class="p">,</span> <span class="n">cfg</span><span class="p">.</span><span class="n">image_size</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">diff</span><span class="p">.</span><span class="n">timesteps</span><span class="p">)):</span>
        <span class="n">t_batch</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">full</span><span class="p">((</span><span class="n">batch</span><span class="p">,),</span> <span class="n">t</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="n">eps</span>     <span class="o">=</span> <span class="n">net</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t_batch</span><span class="p">.</span><span class="nb">float</span><span class="p">()</span> <span class="o">/</span> <span class="n">diff</span><span class="p">.</span><span class="n">timesteps</span><span class="p">)</span>
        <span class="n">alpha</span>   <span class="o">=</span> <span class="n">diff</span><span class="p">.</span><span class="n">alphas</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
        <span class="n">a_hat</span>   <span class="o">=</span> <span class="n">diff</span><span class="p">.</span><span class="n">alpha_hats</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
        <span class="n">beta</span>    <span class="o">=</span> <span class="n">diff</span><span class="p">.</span><span class="n">betas</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
        <span class="n">noise</span>   <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">randn_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">torch</span><span class="p">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="n">alpha</span><span class="p">.</span><span class="n">sqrt</span><span class="p">())</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">/</span> <span class="n">a_hat</span><span class="p">.</span><span class="n">sqrt</span><span class="p">()</span> <span class="o">*</span> <span class="n">eps</span><span class="p">)</span> <span class="o">+</span> <span class="n">beta</span><span class="p">.</span><span class="n">sqrt</span><span class="p">()</span> <span class="o">*</span> <span class="n">noise</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">.</span><span class="n">clamp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># ──────────────────────────────────────────
# 5.  Generate &amp; save
# ──────────────────────────────────────────
</span><span class="n">Path</span><span class="p">(</span><span class="n">infer</span><span class="p">.</span><span class="n">out_dir</span><span class="p">).</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">images</span> <span class="o">=</span> <span class="n">sample</span><span class="p">(</span><span class="n">infer</span><span class="p">.</span><span class="n">n_samples</span><span class="p">)</span>
<span class="n">save_image</span><span class="p">((</span><span class="n">images</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
           <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">infer</span><span class="p">.</span><span class="n">out_dir</span><span class="si">}</span><span class="s">/sample.png"</span><span class="p">,</span>
           <span class="n">nrow</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="p">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">infer</span><span class="p">.</span><span class="n">n_samples</span><span class="p">)))</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"✅  Saved </span><span class="si">{</span><span class="n">infer</span><span class="p">.</span><span class="n">n_samples</span><span class="si">}</span><span class="s"> images to </span><span class="si">{</span><span class="n">infer</span><span class="p">.</span><span class="n">out_dir</span><span class="si">}</span><span class="s">/sample.png"</span><span class="p">)</span>

</code></pre></div></div> </main> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
